#!/usr/bin/env node
const log = require('./logger');

log.info('Drone downstream registry plugin');

try {
  log.info('Reading and verifying parameters');
  const params = require('./params');

  if (!params.registry.downstream) {
    log.info(`Downstream build flag not set`);
    log.info(`Assume normal build. Exiting.`);
    return;
  }

  log.info('Building registry file storage');
  const storage = require('./fileStorage')(params.plugin.registryPath);

  log.info('Building registry');
  const registry = require('./registry')(storage);


  Object.keys(process.env).forEach((name) => log.info(`${name}=${process.env[name]}`));


  switch (params.plugin.action) {
    case 'package-build':
      log.info('Executing [package-build]');
      registry.createPackageEntry(
        params.registry.package,
        params.registry.version,
        params.plugin.repositories
      );
      log.info(`Successfully registered package ${params.registry.package} version ${params.registry.version}`);
      log.info(`Awaiting downstream builds:`);
      params.plugin.repositories.forEach((repo) => log.info(`\t${repo}`));

      break;

    case 'downstream-build':
      log.info('Executing [downstream-build]');
      registry.registerDownstreamBuild(
        params.registry.package,
        params.registry.version,
        params.registry.buildRepo,
        params.registry.buildStatus,
        params.registry.buildNumber
      );

      const status = registry.currentPackageStatus(
        params.registry.package,
        params.registry.version
      );

      log.info(`Current package cumulative status: ${status.toUpperCase()}`);

      break;
  }
} catch (e) {
  log.error(`Error: ${e.message}`);
  process.exit(1);
}


